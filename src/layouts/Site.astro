---
import "../styles/app-shell.css";
import { APP } from "../config/app";
import pkg from "../../package.json";

const {
  title = APP.name,
  description = "",
  robots = "index",
  canonical = Astro.url.href,
} = Astro.props as {
  title?: string;
  description?: string;
  robots?: string;
  canonical?: string;
};

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL ?? "";
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY ?? "";
const memberCardVerifyPubKey = import.meta.env.PUBLIC_MEMBER_CARD_VERIFY_PUBKEY ?? "";
const vapidPublicKey = import.meta.env.PUBLIC_VAPID_PUBLIC_KEY ?? "";
const appVersionEnv = String(import.meta.env.PUBLIC_APP_VERSION ?? "").trim();
const pkgVersion = String(pkg?.version || "0.1.0").trim();
const appVersion = appVersionEnv && appVersionEnv !== "dev-local" ? appVersionEnv : `${pkgVersion}-local`;

// Guard member area paths:
const path = Astro.url.pathname.toLowerCase();
const isScannerPath = path.startsWith("/app/ausweis/verifizieren/");
const needsMemberGuard = path.startsWith("/app/") && !isScannerPath;
---

<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <meta name="robots" content={`${robots},follow`} />
    <link rel="canonical" href={canonical} />
    <meta name="theme-color" content="#0b1220" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content={APP.brand} />
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="stylesheet" href="/css/ui-standards.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/consent-manager.css" />
  </head>
  <body
    data-supabase-url={supabaseUrl}
    data-supabase-key={supabaseKey}
    data-member-card-verify-pubkey={memberCardVerifyPubKey}
    data-vapid-public-key={vapidPublicKey}
    data-app-version={appVersion}
  >
    <header class="header">
      <div class="container">
        <nav class="nav" aria-label="Hauptnavigation">
          <a class="logo" href="/" aria-label={APP.name}>
            <img src="/Bilder/logo300x300.png" alt={APP.name} />
          </a>
          <div class="nav-actions">
            <span id="netStatusBadge" class="small hidden" hidden>Offline</span>
            <div class="burger-menu" id="burgerMenu">
              <button type="button" id="burgerToggle" class="burger-toggle" aria-label="Menü">
                <span>☰</span>
              </button>
              <div id="burgerPopover" class="burger-popover hidden" hidden>
                <a href="/">Start</a>
                <a href="/termine.html/">Termine</a>
                <a href="/vdan-jugend.html/">Jugend</a>
                <a href="/mitglied-werden.html/">Mitglied werden</a>
                <a href="/fischereipruefung.html/">Fischereiprüfung</a>
                <a href="/anglerheim-ottenheim.html/">Anglerheim</a>
                <a href="/downloads.html/">Downloads</a>
                <a href="/kontakt.html/">Kontakt</a>
                <a href="/datenschutz.html/">Datenschutz</a>
                <a href="/impressum.html/">Impressum</a>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <button
      type="button"
      id="portalQuickToggle"
      class="portal-quick-toggle hidden"
      hidden
      data-member-only
      data-ui-session-skip
      aria-label="Portal öffnen"
    >
      <span aria-hidden="true">⌂</span>
      <span id="portalQuickUserBadge" class="portal-quick-user-badge hidden" hidden aria-hidden="true"></span>
    </button>
    <aside id="portalRail" class="portal-rail hidden" hidden data-member-only data-ui-session-skip aria-label="Portal-Kurzmenü">
      <div id="portalRailItems" class="portal-rail__items"></div>
    </aside>
    <div id="portalQuickDrawer" class="portal-quick-drawer hidden" hidden data-member-only data-ui-session-skip>
      <section id="portalQuickPanel" class="portal-quick-panel" aria-label="Portal Kurzmenü">
        <div class="portal-quick-panel__head">
          <h2>Portal</h2>
        </div>
        <p class="small">Schnellzugriff für deine Favoriten.</p>
        <div id="portalQuickList" class="portal-quick-list"></div>
      </section>
    </div>

    <main class="main">
      <div class="container">
        <slot />
      </div>
    </main>

    <footer class="site-footer">
      <div class="container site-footer__inner">
        <p class="small">© VDAN Ottenheim</p>
        <nav class="site-footer__links" aria-label="Rechtliche Links">
          <a href="/kontakt.html/">Kontakt</a>
          <a href="/datenschutz.html/">Datenschutz</a>
          <a href="/impressum.html/">Impressum</a>
          <a href="#" data-open-consent-settings>Datenschutz-Einstellungen</a>
        </nav>
      </div>
    </footer>

    <script is:inline src="/js/runtime-guard.js"></script>
    <script src="/js/app-env.js" defer></script>
    <script src="/js/offline-data-store.js" defer></script>
    <script src="/js/offline-sync.js" defer></script>
    <script src="/js/consent-manager.js" defer></script>
    <script src="/js/member-auth.js" defer></script>
    {needsMemberGuard && <script src="/js/member-guard.js" defer></script>}
    <script src="/js/ui-session.js" defer></script>
    <script src="/js/nav-burger.js" defer></script>
    <script src="/js/portal-quick.js" defer></script>
    <script src="/js/pwa-register.js" defer></script>
    <!-- <script src="/js/maintenance-gate.js" defer></script> -->
  </body>
</html>
